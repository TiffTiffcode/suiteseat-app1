<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Book an Appointment</title>
  <link rel="stylesheet" href="/qassets/css/booking-page.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <button id="logout-btn"
  style="position:fixed;top:8px;right:8px;z-index:99999;padding:6px 10px;">
  Log out
</button>

<script>
document.getElementById('logout-btn')?.addEventListener('click', async () => {
  try {
    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
  } finally {
    // wipe any client state
    try { localStorage.clear(); sessionStorage.clear(); } catch {}
    window.BookingApp ??= {}; 
    window.BookingApp.STATE ??= {};
    window.BookingApp.STATE.user = { loggedIn:false, hydrated:false, continueAfterLogin:false };
    location.reload();
  }
});
</script>

  <div class="container">
    <!-- In views/booking-page.ejs (or your page HTML) -->
<div id="auth-controls" class="auth-controls">
  <h1>log in</h1>
  <span id="login-status-text"></span>
  <button id="logout-btn" class="btn btn--ghost" style="display:none;">Log out</button>
</div>

    <!-- HERO -->
    <section id="hero" class="hero">
      <img id="heroImg" class="hero__img" src="" alt="" />
      <div class="hero__meta">
        <h1 id="bizName" class="hero__title">Loadingâ€¦</h1>
        <div id="bizSub" class="hero__sub"></div>
      </div>
    </section>

    <!-- CALENDARS -->
    <section class="section">
      <h3 class="section__title">Choose a calendardesrgfvas</h3>
      <div id="calendars" class="grid grid--3"></div>
    </section>

    <!-- CATEGORIES -->
    <section class="section" id="section-cats" style="display:none;">
      <h3 class="section__title">Choose a category</h3>
      <div id="categories" class="grid grid--3"></div>
    </section>

    <!-- SERVICES -->
    <section class="section" id="section-services" style="display:none;">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <h3 class="section__title">Choose service(s)</h3>
        <label class="toggle" style="display:none">
          <input id="toggle-multi" type="checkbox" />
          Add Multiple Services
        </label>
      </div>
      <div id="services" class="grid grid--2"></div>
      <div class="divider"></div>
      <div id="summary" class="badge" style="display:none;"></div>
    </section>


    <!-- AVAILABILITY -->
  <section class="section section--bleed" id="section-availability" style="display:none;">
  <h3 class="section__title">Availability</h3>
  <div id="datePicker" class="calendar"></div>
  <div id="timeslots" class="timeslots is-grouped"></div>
</section>


    <!-- CONFIRM CTA -->
    <!-- CONFIRM CTA (same id, now behaves like a modal) -->
<section class="section as-modal" id="section-confirm" style="display:none;">
  <div class="modal__scrim" data-close="1"></div>

  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <button class="modal__close" aria-label="Close" data-close="1">Ã—</button>

    <h3 id="confirm-title" class="section__title">Confirm</h3>
    <div id="confirm-summary" class="card"></div>

    <div class="sticky-footer">
   <button id="btn-confirm" type="button" class="btn btn--primary btn--full">Book Now</button>

    </div>
  </div>
</section>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal">
    <div class="modal__scrim" onclick="closeAuth()"></div>
    <div class="modal__panel">
      <button class="modal__close" onclick="closeAuth()">Ã—</button>
      <h3 class="modal__title">Sign in to continue</h3>
      <div class="form">
       <input id="firstName" placeholder="First name">
<input id="lastName"  placeholder="Last name">
 
        <label class="label">Email</label>
        <input id="auth-email" class="input" type="email" />
        <label class="label">Password</label>
        <input id="auth-pass" class="input" type="password" />
        <button id="btn-login" class="btn btn--primary1">Sign In</button>
      </div>
      <div class="divider"></div>
      <div  style="font-size:.9rem;">No account yet? Create it automatically at checkout (coming soon) or ask your pro to add you.</div>
    </div>
  </div>
<!-- Stripe Fee Step (hidden until payment) -->
<div id="stripe-fee-step" style="display:none; margin-top:16px;">
  <div id="fee-line" style="font-weight:600; margin-bottom:8px;">
    Service fee: <span id="fee-amount">$2.33</span>
  </div>

  <div id="card-element" style="padding:12px; border:1px solid #ddd; border-radius:8px;"></div>
  <div id="card-errors" role="alert" style="color:#b00020; margin-top:8px;"></div>

  <button id="pay-fee-btn" class="primary-btn" style="margin-top:12px;">Pay Fee & Continue</button>
</div>

  <!-- SUCCESS MODAL -->
  <div id="successModal" class="modal">
    <div class="modal__scrim" onclick="closeSuccess()"></div>
    <div class="modal__panel">
      <button class="modal__close" onclick="closeSuccess()">Ã—</button>
      <h3 class="modal__title">Appointment booked ðŸŽ‰</h3>
      <div id="success-details" class="form"></div>
      <div class="row" style="margin-top:12px;">
        <button class="btn btn--ghost" onclick="closeSuccess()">Done</button>
<button class="btn btn--primary1" onclick="redirectToClientDashboard()">
  Go to Client Dashboard
</button>


</div>
    </div>
  </div>

  
  <div id="page-error" style="display:none"></div>

<img id="business-hero" style="display:none" />

<section id="availability-section"></section>

<style>
  /* make text readable on dark cards */
  .card, .card--select { color: #f5f7fa; }
  .card__title, .service__name { color: #ffffff; }
  .card__sub, .service__sub, .muted { color: #b5bdc9; }
  /* if buttons look too dark, brighten them a bit */
  .btn.btn--pill { color: #111; background: #e9eef5; }
</style>


 <script src="https://js.stripe.com/v3"></script>
<!-- views/booking-page.ejs -->
<!-- your compiled bundle -->
<script src="/qassets/js/booking-page.js?v=172" defer></script>

<!-- IDs used by the creator -->
<script>
  console.log('[config] inject IDs');
  window.CONFIG ??= {};
  window.CONFIG.dataTypeIds ??= {};
  window.CONFIG.dataTypeIds.Appointment = '68aec5009f8cc70218a927f7';
  window.CONFIG.dataTypeIds.Client      = '68aec5439f8cc70218a9280c';
</script>

<!-- guard #1: block POST /api/records if logged out + inject createdBy when logged in -->
<script>
(function gateRecordsPost(){
  console.log('[guard] install fetch gate');
  const origFetch = window.fetch;

  function openAuth(){ document.getElementById('authModal')?.classList.add('is-open'); }
  async function me(){
    try {
      const r = await origFetch('/api/users/me?ts='+Date.now(), { credentials:'include' });
      if (!r.ok) return null;
      const j = await r.json().catch(()=> ({}));
      return j?.user?._id || null;
    } catch { return null; }
  }

  window.fetch = async function(input, init = {}){
    const url    = typeof input === 'string' ? input : (input?.url || '');
    const method = (init.method || 'GET').toUpperCase();

    if (method === 'POST' && url.startsWith('/api/records')) {
      const userId = await me();
      if (!userId) {
        console.warn('[guard] blocked POST /api/records â€“ not logged in');
        window.BookingApp ??= {}; window.BookingApp.STATE ??= {};
        window.BookingApp.STATE.user = { ...(window.BookingApp.STATE.user||{}), continueAfterLogin:true };
        openAuth();
        throw new Error('LOGIN_REQUIRED');         // prevents the 500
      }
      // inject createdBy if missing
      try {
        const body = init.body && JSON.parse(init.body);
        if (body && !body.createdBy) {
          body.createdBy = userId;
          init.body = JSON.stringify(body);
          console.log('[guard] injected createdBy', userId);
        }
      } catch {}
    }
    return origFetch(input, init);
  };
})();
</script>

<!-- guard #2: stop the Book Now click early if logged out (belt & suspenders) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('[guard] wire #btn-confirm click check');
  const btn = document.getElementById('btn-confirm');
  if (!btn || btn.__wiredConfirmGuard) return;
  btn.__wiredConfirmGuard = true;

  btn.addEventListener('click', (e) => {
    const uid = window.BookingApp?.STATE?.user?.userId;
    if (!uid) {
      console.warn('[guard] open auth before booking');
      e.preventDefault(); e.stopPropagation();
      window.BookingApp ??= {}; window.BookingApp.STATE ??= {};
      window.BookingApp.STATE.user = { ...(window.BookingApp.STATE.user||{}), continueAfterLogin:true };
      document.getElementById('authModal')?.classList.add('is-open');
    }
  }, true);
});
</script>

<!-- resume after login -->
<script>
(function wireResumeAfterLogin(){
  console.log('[guard] resume after login installed');
  const prev = window.onLoginClick;
  window.onLoginClick = async function(e){
    try { if (prev) await prev(e); } finally {
      const ST = window.BookingApp?.STATE;
      if (ST?.user?.continueAfterLogin) {
        ST.user.continueAfterLogin = false;
        console.log('[guard] resuming booking after login');
        document.getElementById('btn-confirm')?.click();
      }
    }
  };
})();
</script>
<script>
  window.CONFIG ??= {};
  window.CONFIG.API_BASE = 'http://localhost:8400';
  window.CONFIG.dataTypeIds = {
    Appointment: '68aec5009f8cc70218a927f7',
    Client:      '68aec5439f8cc70218a9280c'
  };
</script>


</body>
</html>
